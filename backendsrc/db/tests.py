from django.test import TestCase
import requests
from models import Station
from db.serializers import SimulationOutputSerializer
from datetime import time, date, datetime
import json
import ast
from ..backend.sim import Station, Itinerary

# Create your tests here.

api = "https://api.tripgo.com/v1/routing.json"
key = "2286d1ca160dd724a3da27802c7aba91"
#modes = ["pt_pub_bus", "pt_pub_train"]
modes = ["pt_pub_bus"]
endStation = "(-27.464867,153.009186)" #default suncorp stadium 



#save itinerary to database
#to do: update new itineraries to database
def cacheItinerary():
    return False 

def createItineraries(stations: list[Station]):
    #get cached initeraries where the start station is in the list
    #to do: create database structure
    db_itin = ItineraryM.objects.all().filter(start_id__in=list(map(lambda station: station.id, stations)))
    sim_itineraries = []

    for station in stations: 
        cached = db_itin.filter(start_id=station.id)
        newItin = None
        if cached:
              #todo: create Itinerary object
              newItin = Itinerary()
        else:
            stationPos = getStationPos(station)
            parameters = {
                "v": "11",
                "from" : stationPos,
                "to" : endStation,
                "modes": modes,
                "bestOnly": "true",
                "includeStops": "false"
            }
            headers = {
                "X-TripGo-Key": key  
            }
            data = callTripGoAPI(api, parameters, headers)
            #todo: create Itinerary object
            newItin = cacheItinerary(data)
        sim_itineraries.append(newItin)

    return sim_itineraries
        
       

#call the api for itinerary of a single trip
#to do: json data manipulation
#to do: decide on parameters
def callTripGoAPI(api, parameters, headers):
        response = requests.get(api, params = parameters, headers = headers)
        if response.status_code == 200:
            print("sucessfully fetched TripGo data")
            print(response.json().get("groups", {})[0].get("trips"))
            return response.json()
        else:
            raise Exception(f"{response.status_code}")


#get the formatted position of a station
def getStationPos(station: Station):
    pos = station.pos
    return(f"{pos[0]}, {pos[1]}")


if __name__ == "__main__":
    parameters = {
                "v": "11",
                "from" : "(-27.335962, 152.952169)",
                "to" : endStation,
                "modes": modes,
                "bestOnly": "true",
                "includeStops": "false"
            }
    headers = {
                "X-TripGo-Key": key  
            }
    '''
    sampledata = "[{'arrive': 1696144393, 'availability': 'AVAILABLE', 'caloriesCost': 64, 'carbonCost': 2.5, 'currency': 'AUD', 'currencySymbol': '$', 'depart': 1696140332, 'hassleCost': 2, 'hideExactTimes': False, 'id': '7d40c847-cf07-47e6-80a1-285024a1287b', 'mainSegmentHashCode': -146506748, 'moneyCost': 3.29, 'moneyUSDCost': 2.37, 'queryIsLeaveAfter': True, 'queryMinimumTransferSeconds': 180, 'queryTime': 1696133420, 'segments': [{'availability': 'AVAILABLE', 'endTime': 1696140660, 'id': 'f8sKPOXU', 'segmentTemplateHashCode': 107587142, 'startTime': 1696140332}, {'availability': 'AVAILABLE', 'endPlatform': '1', 'endTime': 1696143180, 'externalData': {'directionId': 0, 'operatorName': 'Translink', 'routeId': '359-3226', 'stopId': '010063', 'type': 'gtfs'}, 'id': '9l9qsYbd', 'routeDirection': 0, 'routeID': '359-3226', 'routeId': '359-3226', 'segmentTemplateHashCode': -146506748, 'serviceColor': {'blue': 63, 'green': 198, 'red': 141}, 'serviceDirection': 'City, Queen St', 'serviceName': 'Eatonvale - City Express via Albany Village', 'serviceNumber': '359', 'serviceTextColor': {'blue': 0, 'green': 0, 'red': 0}, 'serviceTripID': '25910589-BT 23_24-34420', 'startTime': 1696140660, 'stops': 28, 'ticket': {'cost': 3.29, 'exchange': 0.72, 'name': 'Brisbane 2 Zones Off-Peak Ticket'}, 'ticketWebsiteURL': 'https://translink.com.au/'}, {'availability': 'AVAILABLE', 'endTime': 1696144393, 'id': '1eVhOd0d', 'segmentTemplateHashCode': 1678135970, 'startTime': 1696143180}], 'weightedScore': 37.1}, {'arrive': 1696130353, 'availability': 'AVAILABLE', 'caloriesCost': 64, 'carbonCost': 2.5, 'currency': 'AUD', 'currencySymbol': '$', 'depart': 1696125992, 'hassleCost': 2, 'hideExactTimes': False, 'id': 'b811a2e6-69f5-49b3-833f-b9a88f7d501c', 'mainSegmentHashCode': -146506748, 'moneyCost': 3.29, 'moneyUSDCost': 2.37, 'queryIsLeaveAfter': True, 'queryMinimumTransferSeconds': 180, 'queryTime': 1696133420, 'segments': [{'availability': 'AVAILABLE', 'endTime': 1696126320, 'id': 'XV0HGG7x', 'segmentTemplateHashCode': 107587142, 'startTime': 1696125992}, {'availability': 'AVAILABLE', 'endPlatform': '1', 'endTime': 1696129140, 'externalData': {'directionId': 0, 'operatorName': 'Translink', 'routeId': '359-3226', 'stopId': '010063', 'type': 'gtfs'}, 'id': 'Ucged4YA', 'routeDirection': 0, 'routeID': '359-3226', 'routeId': '359-3226', 'segmentTemplateHashCode': -146506748, 'serviceColor': {'blue': 63, 'green': 198, 'red': 141}, 'serviceDirection': 'City, Queen St', 'serviceName': 'Eatonvale - City Express via Albany Village', 'serviceNumber': '359', 'serviceTextColor': {'blue': 0, 'green': 0, 'red': 0}, 'serviceTripID': '25909462-BT 23_24-34420', 'startTime': 1696126320, 'stops': 28, 'ticket': {'cost': 3.29, 'exchange': 0.72, 'name': 'Brisbane 2 Zones Off-Peak Ticket'}, 'ticketWebsiteURL': 'https://translink.com.au/'}, {'availability': 'AVAILABLE', 'endTime': 1696130353, 'id': 'Pv5nRFlQ', 'segmentTemplateHashCode': 1678135970, 'startTime': 1696129140}], 'weightedScore': 195.7}, {'arrive': 1696137191, 'availability': 'AVAILABLE', 'caloriesCost': 64, 'carbonCost': 2.5, 'currency': 'AUD', 'currencySymbol': '$', 'depart': 1696133102, 'hassleCost': 2, 'hideExactTimes': False, 'id': '2e3d5e48-0357-40b3-8cc9-ff38769b57f1', 'mainSegmentHashCode': -146506748, 'moneyCost': 3.29, 'moneyUSDCost': 2.37, 'queryIsLeaveAfter': True, 'queryMinimumTransferSeconds': 180, 'queryTime': 1696133420, 'segments': [{'availability': 'AVAILABLE', 'endTime': 1696133430, 'id': 'I26O9gVm', 'segmentTemplateHashCode': 107587142, 'startTime': 1696133102}, {'availability': 'AVAILABLE', 'endPlatform': '1', 'endTime': 1696135978, 'externalData': {'directionId': 0, 'operatorName': 'Translink', 'routeId': '359-3226', 'stopId': '010063', 'type': 'gtfs'}, 'id': '0bm4uUkN', 'realTime': True, 'realtimeStops': [{'code': '010063', 'predictedArrival': 1696133414, 'predictedDeparture': 1696133430}, {'code': '010025', 'predictedArrival': 1696133470, 'predictedDeparture': 1696133470}, {'code': '199001', 'predictedArrival': 1696133513, 'predictedDeparture': 1696133513}, {'code': '014095', 'predictedArrival': 1696133664, 'predictedDeparture': 1696133664}, {'code': '014099', 'predictedArrival': 1696133766, 'predictedDeparture': 1696133766}, {'code': '014023', 'predictedArrival': 1696133886, 'predictedDeparture': 1696133886}, {'code': '014077', 'predictedArrival': 1696134012, 'predictedDeparture': 1696134012}, {'code': '010584', 'predictedArrival': 1696134031, 'predictedDeparture': 1696134031}, {'code': '014078', 'predictedArrival': 1696134099, 'predictedDeparture': 1696134099}, {'code': '014079', 'predictedArrival': 1696134184, 'predictedDeparture': 1696134184}, {'code': '014080', 'predictedArrival': 1696134242, 'predictedDeparture': 1696134242}, {'code': '014081', 'predictedArrival': 1696134335, 'predictedDeparture': 1696134335}, {'code': '014082', 'predictedArrival': 1696134397, 'predictedDeparture': 1696134397}, {'code': '014083', 'predictedArrival': 1696134439, 'predictedDeparture': 1696134439}, {'code': '014084', 'predictedArrival': 1696134481, 'predictedDeparture': 1696134481}, {'code': '014085', 'predictedArrival': 1696134531, 'predictedDeparture': 1696134531}, {'code': '014018', 'predictedArrival': 1696134597, 'predictedDeparture': 1696134597}, {'code': '014017', 'predictedArrival': 1696134649, 'predictedDeparture': 1696134649}, {'code': '004015', 'predictedArrival': 1696134683, 'predictedDeparture': 1696134683}, {'code': '010239', 'predictedArrival': 1696134725, 'predictedDeparture': 1696134725}, {'code': '010500', 'predictedArrival': 1696134780, 'predictedDeparture': 1696134780}, {'code': '002149', 'predictedArrival': 1696134921, 'predictedDeparture': 1696134921}, {'code': '002132', 'predictedArrival': 1696134990, 'predictedDeparture': 1696134990}, {'code': '002086', 'predictedArrival': 1696135084, 'predictedDeparture': 1696135084}, {'code': '002075', 'predictedArrival': 1696135202, 'predictedDeparture': 1696135202}, {'code': '005076', 'predictedArrival': 1696135283, 'predictedDeparture': 1696135283}, {'code': '010077', 'predictedArrival': 1696135615, 'predictedDeparture': 1696135615}, {'code': '000899', 'predictedArrival': 1696135845, 'predictedDeparture': 1696135845}, {'code': '000893', 'predictedArrival': 1696135978, 'predictedDeparture': 1696135978}, {'code': '010792', 'predictedArrival': 1696136095, 'predictedDeparture': 1696136095}, {'code': '000141', 'predictedArrival': 1696136301, 'predictedDeparture': 1696136301}, {'code': '000059', 'predictedArrival': 1696136438, 'predictedDeparture': 1696136481}], 'realtimeVehicle': {'id': '25910024-BT 23_24-34420', 'label': '2285', 'lastUpdate': 1696133380, 'location': {'bearing': 335, 'lat': -27.34047, 'lng': 152.94856}}, 'routeDirection': 0, 'routeID': '359-3226', 'routeId': '359-3226', 'segmentTemplateHashCode': -146506748, 'serviceColor': {'blue': 63, 'green': 198, 'red': 141}, 'serviceDirection': 'City, Queen St', 'serviceName': 'Eatonvale - City Express via Albany Village', 'serviceNumber': '359', 'serviceTextColor': {'blue': 0, 'green': 0, 'red': 0}, 'serviceTripID': '25910024-BT 23_24-34420', 'startTime': 1696133430, 'stops': 28, 'ticket': {'cost': 3.29, 'exchange': 0.72, 'name': 'Brisbane 2 Zones Off-Peak Ticket'}, 'ticketWebsiteURL': 'https://translink.com.au/', 'timetableEndTime': 1696135980, 'timetableStartTime': 1696133460}, {'availability': 'AVAILABLE', 'endTime': 1696137191, 'id': 'qATbIKVP', 'segmentTemplateHashCode': 1678135970, 'startTime': 1696135978}], 'weightedScore': 35.9}, {'arrive': 1696151593, 'availability': 'AVAILABLE', 'caloriesCost': 64, 'carbonCost': 2.5, 'currency': 'AUD', 'currencySymbol': '$', 'depart': 1696147532, 'hassleCost': 2, 'hideExactTimes': False, 'id': '1ff8ec28-30ac-4f35-8dc4-c80cc4b15009', 'mainSegmentHashCode': -146506748, 'moneyCost': 3.29, 'moneyUSDCost': 2.37, 'queryIsLeaveAfter': True, 'queryMinimumTransferSeconds': 180, 'queryTime': 1696133420, 'segments': [{'availability': 'AVAILABLE', 'endTime': 1696147860, 'id': 'bjonlIo1', 'segmentTemplateHashCode': 107587142, 'startTime': 1696147532}, {'availability': 'AVAILABLE', 'endPlatform': '1', 'endTime': 1696150380, 'externalData': {'directionId': 0, 'operatorName': 'Translink', 'routeId': '359-3226', 'stopId': '010063', 'type': 'gtfs'}, 'id': 'JJZZ7hQR', 'routeDirection': 0, 'routeID': '359-3226', 'routeId': '359-3226', 'segmentTemplateHashCode': -146506748, 'serviceColor': {'blue': 63, 'green': 198, 'red': 141}, 'serviceDirection': 'City, Queen St', 'serviceName': 'Eatonvale - City Express via Albany Village', 'serviceNumber': '359', 'serviceTextColor': {'blue': 0, 'green': 0, 'red': 0}, 'serviceTripID': '25911135-BT 23_24-34420', 'startTime': 1696147860, 'stops': 28, 'ticket': {'cost': 3.29, 'exchange': 0.72, 'name': 'Brisbane 2 Zones Off-Peak Ticket'}, 'ticketWebsiteURL': 'https://translink.com.au/'}, {'availability': 'AVAILABLE', 'endTime': 1696151593, 'id': '8JrHQ2RB', 'segmentTemplateHashCode': 1678135970, 'startTime': 1696150380}], 'weightedScore': 45.1}, {'arrive': 1696140793, 'availability': 'AVAILABLE', 'caloriesCost': 64, 'carbonCost': 2.5, 'currency': 'AUD', 'currencySymbol': '$', 'depart': 1696136732, 'hassleCost': 2, 'hideExactTimes': False, 'id': '9ced0173-d34c-4ab9-979f-2aceedd26249', 'mainSegmentHashCode': -146506748, 'moneyCost': 3.29, 'moneyUSDCost': 2.37, 'queryIsLeaveAfter': True, 'queryMinimumTransferSeconds': 180, 'queryTime': 1696133420, 'segments': [{'availability': 'AVAILABLE', 'endTime': 1696137060, 'id': 'yd0hXD1e', 'segmentTemplateHashCode': 107587142, 'startTime': 1696136732}, {'availability': 'AVAILABLE', 'endPlatform': '1', 'endTime': 1696139580, 'externalData': {'directionId': 0, 'operatorName': 'Translink', 'routeId': '359-3226', 'stopId': '010063', 'type': 'gtfs'}, 'id': 'CTe9QZ1K', 'realTime': True, 'realTimeStatus': 'IS_REAL_TIME', 'realtimeStops': [{'code': '010167', 'predictedArrival': 1696136940, 'predictedDeparture': 1696136940}, {'code': '010186', 'predictedArrival': 1696137000, 'predictedDeparture': 1696137000}, {'code': '010063', 'predictedArrival': 1696137060, 'predictedDeparture': 1696137060}, {'code': '010025', 'predictedArrival': 1696137120, 'predictedDeparture': 1696137120}, {'code': '199001', 'predictedArrival': 1696137180, 'predictedDeparture': 1696137180}, {'code': '014095', 'predictedArrival': 1696137300, 'predictedDeparture': 1696137300}, {'code': '014099', 'predictedArrival': 1696137480, 'predictedDeparture': 1696137480}, {'code': '014023', 'predictedArrival': 1696137540, 'predictedDeparture': 1696137540}, {'code': '014077', 'predictedArrival': 1696137660, 'predictedDeparture': 1696137660}, {'code': '010584', 'predictedArrival': 1696137661, 'predictedDeparture': 1696137661}, {'code': '014078', 'predictedArrival': 1696137780, 'predictedDeparture': 1696137780}, {'code': '014079', 'predictedArrival': 1696137840, 'predictedDeparture': 1696137840}, {'code': '014080', 'predictedArrival': 1696137900, 'predictedDeparture': 1696137900}, {'code': '014081', 'predictedArrival': 1696137960, 'predictedDeparture': 1696137960}, {'code': '014082', 'predictedArrival': 1696138020, 'predictedDeparture': 1696138020}, {'code': '014083', 'predictedArrival': 1696138080, 'predictedDeparture': 1696138080}, {'code': '014084', 'predictedArrival': 1696138140, 'predictedDeparture': 1696138140}, {'code': '014085', 'predictedArrival': 1696138200, 'predictedDeparture': 1696138200}, {'code': '014018', 'predictedArrival': 1696138260, 'predictedDeparture': 1696138260}, {'code': '014017', 'predictedArrival': 1696138320, 'predictedDeparture': 1696138320}, {'code': '004015', 'predictedArrival': 1696138380, 'predictedDeparture': 1696138380}, {'code': '010239', 'predictedArrival': 1696138381, 'predictedDeparture': 1696138381}, {'code': '010500', 'predictedArrival': 1696138440, 'predictedDeparture': 1696138440}, {'code': '002149', 'predictedArrival': 1696138620, 'predictedDeparture': 1696138620}, {'code': '002132', 'predictedArrival': 1696138680, 'predictedDeparture': 1696138680}, {'code': '002086', 'predictedArrival': 1696138740, 'predictedDeparture': 1696138740}, {'code': '002075', 'predictedArrival': 1696138860, 'predictedDeparture': 1696138860}, {'code': '005076', 'predictedArrival': 1696138920, 'predictedDeparture': 1696138920}, {'code': '010077', 'predictedArrival': 1696139280, 'predictedDeparture': 1696139280}, {'code': '000899', 'predictedArrival': 1696139520, 'predictedDeparture': 1696139520}, {'code': '000893', 'predictedArrival': 1696139580, 'predictedDeparture': 1696139580}, {'code': '010792', 'predictedArrival': 1696139760, 'predictedDeparture': 1696139760}, {'code': '000141', 'predictedArrival': 1696140060, 'predictedDeparture': 1696140060}, {'code': '000059', 'predictedArrival': 1696140240}], 'routeDirection': 0, 'routeID': '359-3226', 'routeId': '359-3226', 'segmentTemplateHashCode': -146506748, 'serviceColor': {'blue': 63, 'green': 198, 'red': 141}, 'serviceDirection': 'City, Queen St', 'serviceName': 'Eatonvale - City Express via Albany Village', 'serviceNumber': '359', 'serviceTextColor': {'blue': 0, 'green': 0, 'red': 0}, 'serviceTripID': '25910309-BT 23_24-34420', 'startTime': 1696137060, 'stops': 28, 'ticket': {'cost': 3.29, 'exchange': 0.72, 'name': 'Brisbane 2 Zones Off-Peak Ticket'}, 'ticketWebsiteURL': 'https://translink.com.au/', 'timetableEndTime': 1696139580, 'timetableStartTime': 1696137060}, {'availability': 'AVAILABLE', 'endTime': 1696140793, 'id': 'ksb6sQNM', 'segmentTemplateHashCode': 1678135970, 'startTime': 1696139580}], 'weightedScore': 33.1}, {'arrive': 1696133593, 'availability': 'AVAILABLE', 'caloriesCost': 64, 'carbonCost': 2.5, 'currency': 'AUD', 'currencySymbol': '$', 'depart': 1696129532, 'hassleCost': 2, 'hideExactTimes': False, 'id': '7b7bc93d-5326-45f7-ae9d-1f1978d49088', 'mainSegmentHashCode': -146506748, 'moneyCost': 3.29, 'moneyUSDCost': 2.37, 'queryIsLeaveAfter': True, 'queryMinimumTransferSeconds': 180, 'queryTime': 1696133420, 'segments': [{'availability': 'AVAILABLE', 'endTime': 1696129860, 'id': '5YrR8Qgi', 'segmentTemplateHashCode': 107587142, 'startTime': 1696129532}, {'availability': 'AVAILABLE', 'endPlatform': '1', 'endTime': 1696132380, 'externalData': {'directionId': 0, 'operatorName': 'Translink', 'routeId': '359-3226', 'stopId': '010063', 'type': 'gtfs'}, 'id': 'Acc12DvJ', 'routeDirection': 0, 'routeID': '359-3226', 'routeId': '359-3226', 'segmentTemplateHashCode': -146506748, 'serviceColor': {'blue': 63, 'green': 198, 'red': 141}, 'serviceDirection': 'City, Queen St', 'serviceName': 'Eatonvale - City Express via Albany Village', 'serviceNumber': '359', 'serviceTextColor': {'blue': 0, 'green': 0, 'red': 0}, 'serviceTripID': '25909741-BT 23_24-34420', 'startTime': 1696129860, 'stops': 28, 'ticket': {'cost': 3.29, 'exchange': 0.72, 'name': 'Brisbane 2 Zones Off-Peak Ticket'}, 'ticketWebsiteURL': 'https://translink.com.au/'}, {'availability': 'AVAILABLE', 'endTime': 1696133593, 'id': 'NSpGScGh', 'segmentTemplateHashCode': 1678135970, 'startTime': 1696132380}], 'weightedScore': 115.9}, {'arrive': 1696147993, 'availability': 'AVAILABLE', 'caloriesCost': 64, 'carbonCost': 2.5, 'currency': 'AUD', 'currencySymbol': '$', 'depart': 1696143932, 'hassleCost': 2, 'hideExactTimes': False, 'id': 'cc1cd842-3200-466f-9a3e-ceae7e241cc1', 'mainSegmentHashCode': -146506748, 'moneyCost': 3.29, 'moneyUSDCost': 2.37, 'queryIsLeaveAfter': True, 'queryMinimumTransferSeconds': 180, 'queryTime': 1696133420, 'segments': [{'availability': 'AVAILABLE', 'endTime': 1696144260, 'id': 'CSayUGie', 'segmentTemplateHashCode': 107587142, 'startTime': 1696143932}, {'availability': 'AVAILABLE', 'endPlatform': '1', 'endTime': 1696146780, 'externalData': {'directionId': 0, 'operatorName': 'Translink', 'routeId': '359-3226', 'stopId': '010063', 'type': 'gtfs'}, 'id': 'nzzJ947L', 'routeDirection': 0, 'routeID': '359-3226', 'routeId': '359-3226', 'segmentTemplateHashCode': -146506748, 'serviceColor': {'blue': 63, 'green': 198, 'red': 141}, 'serviceDirection': 'City, Queen St', 'serviceName': 'Eatonvale - City Express via Albany Village', 'serviceNumber': '359', 'serviceTextColor': {'blue': 0, 'green': 0, 'red': 0}, 'serviceTripID': '25910873-BT 23_24-34420', 'startTime': 1696144260, 'stops': 28, 'ticket': {'cost': 3.29, 'exchange': 0.72, 'name': 'Brisbane 2 Zones Off-Peak Ticket'}, 'ticketWebsiteURL': 'https://translink.com.au/'}, {'availability': 'AVAILABLE', 'endTime': 1696147993, 'id': '9k6PCMZl', 'segmentTemplateHashCode': 1678135970, 'startTime': 1696146780}], 'weightedScore': 41.1}]"
    data_list = ast.literal_eval(sampledata)
    print (data_list)
    #callTripGoAPI(api, parameters, headers)
    '''
